sequenceDiagram
    participant User as ğŸ‘¤ Utilisateur
    participant Gateway as ğŸšª API Gateway<br/>(NGINX)
    participant Keycloak as ğŸ” Keycloak<br/>(IdP)
    participant Service as ğŸ”§ Microservice
    participant DB as ğŸ—„ï¸ Database

    Note over User,DB: Principe Zero Trust: Ne jamais faire confiance, toujours vÃ©rifier

    rect rgb(255, 230, 230)
        Note over User,Keycloak: Phase 1: Authentification
        User->>Gateway: 1. RequÃªte de connexion<br/>(HTTPS/TLS)
        Gateway->>Keycloak: 2. Redirection vers IdP
        Keycloak->>User: 3. Page de connexion
        User->>Keycloak: 4. Credentials (username/password)
        Keycloak->>Keycloak: 5. Validation MFA (optionnel)
        Keycloak->>User: 6. JWT Access Token + Refresh Token
    end

    rect rgb(230, 255, 230)
        Note over User,Service: Phase 2: Autorisation (RBAC)
        User->>Gateway: 7. RequÃªte API + JWT Token<br/>(Header: Authorization Bearer)
        Gateway->>Gateway: 8. Validation TLS Certificate
        Gateway->>Keycloak: 9. Validation JWT Token<br/>(Signature, Expiration, Issuer)
        Keycloak->>Gateway: 10. Token Valid + Claims<br/>(roles, permissions)
        Gateway->>Gateway: 11. VÃ©rification RBAC Policy<br/>(route autorisÃ©e pour ce rÃ´le?)
    end

    rect rgb(230, 230, 255)
        Note over Gateway,DB: Phase 3: AccÃ¨s aux Ressources
        Gateway->>Service: 12. RequÃªte forwarded<br/>+ JWT + User Context
        Service->>Service: 13. Validation JWT locale<br/>(double vÃ©rification)
        Service->>Service: 14. VÃ©rification permissions<br/>mÃ©tier (ownership, etc.)
        Service->>DB: 15. RequÃªte DB<br/>(connexion chiffrÃ©e)
        DB->>Service: 16. DonnÃ©es
        Service->>Service: 17. Filtrage donnÃ©es<br/>(selon permissions)
        Service->>Gateway: 18. RÃ©ponse JSON
        Gateway->>User: 19. RÃ©ponse HTTPS
    end

    rect rgb(255, 255, 230)
        Note over User,DB: Phase 4: Audit & Monitoring
        Service->>Service: 20. Log action<br/>(qui, quoi, quand)
        Service->>Service: 21. MÃ©triques Prometheus<br/>(latence, erreurs)
    end

    Note over User,DB: Principes appliquÃ©s:<br/>âœ… Chiffrement end-to-end (TLS)<br/>âœ… Authentification forte (JWT + MFA)<br/>âœ… Autorisation granulaire (RBAC)<br/>âœ… Moindre privilÃ¨ge<br/>âœ… Audit complet<br/>âœ… Segmentation rÃ©seau
